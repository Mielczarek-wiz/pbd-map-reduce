CREATE EXTERNAL TABLE IF NOT EXISTS collisions_ext(street STRING, zip_code STRING, victim_type STRING, injuries_type STRING, value BIGINT) COMMENT 'Collisions on street with injured (killed) people' ROW FORMAT DELIMITED FIELDS TERMINATED BY ',' STORED AS SEQUENCEFILE location '${hiveconf:input_dir3}';

CREATE EXTERNAL TABLE IF NOT EXISTS boroughs_ext(zip_code STRING, boroughs STRING) COMMENT 'Zip codes and boroughs' ROW FORMAT DELIMITED FIELDS TERMINATED BY ',' STORED AS TEXTFILE location '${hiveconf:input_dir4}' TBLPROPERTIES ("skip.header.line.count"="1");

CREATE EXTERNAL TABLE IF NOT EXISTS output_ext(street STRING, victim_type STRING, injuries BIGINT, killed BIGINT) COMMENT 'Result of processing' ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe' STORED AS TEXTFILE LOCATION '${hiveconf:output_dir6}';

INSERT OVERWRITE TABLE output_ext SELECT STREET, TYPE, INJURED, KILLED FROM (SELECT temp_table.street AS STREET, temp_table.victim_type AS TYPE, SUM(temp_table.injured) as INJURED, SUM(temp_table.killed) as KILLED, RANK() OVER(PARTITION BY temp_table.victim_type ORDER BY SUM(temp_table.injured+temp_table.killed) DESC) AS orders FROM (SELECT col.street, col.victim_type, col.injuries_type,CASE WHEN col.injuries_type = 'KILLED' THEN 0 ELSE SUM(col.value) END as injured, CASE WHEN col.injuries_type = 'INJURED' THEN 0 ELSE SUM(col.value) END as killed FROM collisions_ext as col WHERE col.zip_code IN (SELECT bor.zip_code FROM boroughs_ext as bor WHERE bor.boroughs = "MANHATTAN") GROUP BY col.street, col.victim_type, col.injuries_type) as temp_table GROUP BY temp_table.street, temp_table.victim_type) AS OUTPUT_TABLE WHERE orders <= 3 ORDER BY TYPE DESC;
